package com.ssh.dartserver.domain.user;

import com.ssh.dartserver.ApiTest;
import com.ssh.dartserver.UserManager;
import com.ssh.dartserver.domain.university.domain.University;
import com.ssh.dartserver.domain.university.infra.UniversityRepository;
import com.ssh.dartserver.domain.university.presentation.response.UniversityResponse;
import com.ssh.dartserver.domain.user.presentation.v1.request.UserSignUpRequest;
import com.ssh.dartserver.domain.user.presentation.v1.request.UserUpdateRequest;
import com.ssh.dartserver.domain.user.presentation.v1.response.UserProfileResponse;
import com.ssh.dartserver.testing.IntegrationTest;
import io.restassured.response.ExtractableResponse;
import io.restassured.response.Response;
import org.junit.jupiter.api.Nested;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;

import java.util.List;

import static com.ssh.dartserver.domain.university.UniversitySteps.대학생성요청_생성;
import static com.ssh.dartserver.domain.user.UserSteps.*;
import static org.assertj.core.api.Assertions.assertThat;

@IntegrationTest
class UserApiTest extends ApiTest {
    @Autowired
    private UserManager userManager;
    @Autowired
    private UniversityRepository universityRepository;

    @Nested
    class StudentVerifyTest extends StudentVerifyApiTest {
    }

    @Test
    void 회원가입_정보입력() {
        final String jwtToken = userManager.createTestUser().getJwtToken();
        대학생성(10);
        final UserSignUpRequest request = 회원가입요청_생성();

        final ExtractableResponse<Response> response = 회원가입요청(jwtToken, request);

        assertThat(response.statusCode()).isEqualTo(HttpStatus.CREATED.value());
    }

    // GET /v1/users/me
    @Test
    void 내정보_확인하기() {
        final String jwtToken = userManager.createTestUser().getJwtToken();
        대학생성(10);
        회원가입요청(jwtToken, 회원가입요청_생성());

        final ExtractableResponse<Response> response = 내정보확인요청(jwtToken);

        assertThat(response.statusCode()).isEqualTo(HttpStatus.OK.value());
        final UserProfileResponse userProfileResponse = response.body().as(UserProfileResponse.class);
        assertThat(userProfileResponse.getUserResponse()).isNotNull();
        assertThat(userProfileResponse.getUniversityResponse()).isNotNull();
        assertThat(userProfileResponse.getUserResponse().getName()).isEqualTo("테스트");
    }

    // DELETE /v1/users/me
    @Test
    void 회원탈퇴하기() {
        final String jwtToken = userManager.createTestUser().getJwtToken();
        대학생성(10);
        회원가입요청(jwtToken, 회원가입요청_생성());

        final ExtractableResponse<Response> response = 회원탈퇴요청(jwtToken);

        assertThat(response.statusCode()).isEqualTo(HttpStatus.NO_CONTENT.value());
    }

    // PATCH /v1/users/me
    @Test
    void 내정보_수정하기() {
        final String jwtToken = userManager.createTestUser().getJwtToken();
        대학생성(10);
        회원가입요청(jwtToken, 회원가입요청_생성());
        final UserUpdateRequest request = 내정보수정요청_생성();

        final ExtractableResponse<Response> response = 내정보수정요청(jwtToken, request);

        assertThat(response.statusCode()).isEqualTo(HttpStatus.OK.value());
        final UserProfileResponse userProfileResponse = response.body().as(UserProfileResponse.class);
        assertThat(userProfileResponse.getUserResponse().getNickname()).isEqualTo("수정된닉네임");
    }

    private void 대학생성(int count) {
        final List<University> universities = 대학생성요청_생성(count);
        universityRepository.saveAll(universities);
    }
}
